<!DOCTYPE html>
<html lang="zh-TW" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="x-apple-disable-message-reformatting">
  <title>Business Card Scanner</title>
  
  <!-- SheetJS CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Material Design Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    table, td, div, h1, h2, p, button, input {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
    }
    
    body {
      margin: 0;
      padding: 0;
      background-color: #e3e3e3;
    }
    
    /* Material Icons Helper */
    .material-icons {
      font-size: 20px;
      vertical-align: sub;
      margin-right: 4px;
    }

    .btn .material-icons {
      font-size: 28px;
      vertical-align: middle;
      margin-right: 0;
    }

    .form-title .material-icons {
      font-size: 28px;
      vertical-align: middle;
      color: #0066cc;
    }
    
    .container {
      width: 94%;
      max-width: 600px;
      margin: 0 auto;
      background-color: #ffffff;
    }
    
    .header {
      padding: 20px;
      text-align: center;
      background-color: #ffffff;
      border-bottom: 2px solid #f0f0f0;
      position: relative;
    }
    
    .header img {
      width: 200px;
      max-width: 80%;
      height: auto;
    }
    
    .header h1 {
      margin: 10px 0 0 0;
      font-size: 22px;
      line-height: 28px;
      font-weight: bold;
      color: #363636;
    }
    
    /* Language Selector Styles */
    .language-selector {
      margin-top: 30px;
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
      text-align: center;
    }
    
    .language-selector select {
      padding: 8px 12px;
      font-size: 14px;
      font-weight: bold;
      border: 2px solid #0066cc;
      border-radius: 6px;
      background-color: #ffffff;
      color: #0066cc;
      cursor: pointer;
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      min-width: 150px;
    }
    
    .language-selector select:hover {
      background-color: #f0f7ff;
    }
    
    .language-selector select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
    }
    
    .content {
      padding: 20px;
    }
    
    .preview-box {
      width: 100%;
      /* Remove fixed height to allow auto-scaling with image wrapper */
      min-height: 250px; 
      border: 2px dashed #cccccc;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f9f9f9;
      margin-bottom: 15px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      padding: 10px; /* Add padding */
    }

    .preview-box:hover {
      border-color: #0066cc;
      background-color: #f0f7ff;
    }
    
    /* Wrapper to hold image and overlay relative to each other */
    #imageWrapper {
      position: relative;
      display: inline-block;
      max-width: 100%;
    }

    #previewImage {
      display: block;
      max-width: 100%;
      height: auto;
    }
    
    .preview-placeholder {
      text-align: center;
      color: #999999;
      padding: 50px 0;
    }
    
    .preview-placeholder .material-icons {
      font-size: 64px;
      width: 64px;
      height: 64px;
      margin-bottom: 10px;
      opacity: 0.5;
      color: #0066cc;
    }

    /* OCR Overlay Box Styles */
    .ocr-box {
      position: absolute;
      border: 2px solid rgba(0, 102, 204, 0.6);
      background-color: rgba(0, 102, 204, 0.1);
      cursor: help;
      z-index: 10;
      transition: all 0.2s;
    }

    .ocr-box:hover {
      border-color: #ff0000;
      background-color: rgba(255, 0, 0, 0.1);
      z-index: 20;
    }

    /* Tooltip text on hover */
    .ocr-box::after {
      content: attr(data-text);
      position: absolute;
      bottom: 100%;
      left: 0;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      margin-bottom: 4px;
    }

    .ocr-box:hover::after {
      opacity: 1;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .btn {
      flex: 1;
      padding: 14px 20px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background-color: #0066cc;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #0052a3;
    }
    
    .btn-primary:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    .btn-success {
      background-color: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background-color: #218838;
    }
    
    .btn-large {
      width: 100%;
      padding: 16px;
      font-size: 18px;
    }

    .btn-xl {
      width: 100%;
      padding: 32px 20px;
      font-size: 24px;
      min-height: 80px;
    }
    
    .form-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #f0f0f0;
    }
    
    .form-title {
      font-size: 20px;
      font-weight: bold;
      color: #363636;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: bold;
      color: #555555;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #cccccc;
      border-radius: 6px;
      font-family: "Microsoft JhengHei", Arial, sans-serif;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    /* Style for the textarea to match inputs but allow resizing */
    textarea.form-input {
      resize: vertical;
      min-height: 80px;
    }
    
    .footer {
      padding: 20px;
      text-align: center;
      font-size: 12px;
      background-color: #404040;
      color: #cccccc;
    }
    
    .footer p {
      margin: 0;
      font-size: 14px;
      line-height: 20px;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 15px;
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 6px;
      margin-bottom: 15px;
      color: #856404;
    }
    
    .loading.show {
      display: block;
    }
    
    .alert {
      display: none;
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
      align-items: center;
    }

    .alert .material-icons {
      margin-right: 8px;
      font-size: 20px;
      vertical-align: text-bottom;
    }
    
    .alert.show {
      display: block;
    }
    
    .alert-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .alert-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    
    input[type="file"] {
      display: none;
    }
    
    @media screen and (max-width: 480px) {
      .header h1 {
        font-size: 18px;
      }
      
      .btn-xl {
        font-size: 20px;
        padding: 24px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <img src="https://www.transcend-info.com/images/ts_logo.png" alt="TranscendLogo">
      <h1 id="headerTitle">Business Name Card Scanner</h1>
    </div>
    
    <!-- Content -->
    <div class="content">
      <!-- Alert Messages -->
      <div id="alertSuccess" class="alert alert-success"></div>
      <div id="alertError" class="alert alert-error"></div>
      <div id="loadingDiv" class="loading">
        <p id="loadingText"><i class="material-icons">document_scanner</i> Scanning business card, please wait...</p>
        <p id="progressText" style="margin-top: 5px; font-size: 12px;">Loading...</p>
      </div>
      
      <!-- Preview Box -->
      <div class="preview-box" id="previewBox" onclick="triggerFileInput(event)">
        <div class="preview-placeholder">
          <i class="material-icons">add_a_photo</i>
          <p id="previewText">Click to upload a business card</p>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="button-group">
        <button class="btn btn-primary" onclick="openCamera()">
          <span id="btnCamera"><i class="material-icons">photo_camera</i> Camera</span>
        </button>
      </div>
      
      <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
      <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleFileSelect(event)">
      
      <!-- Form Section -->
      <div class="form-section">
        <div class="form-title" id="formTitle"><i class="material-icons">assignment</i> Scan Results</div>
        
        <div class="form-group">
          <label class="form-label" id="labelName"><i class="material-icons">person</i> Name</label>
          <input type="text" class="form-input" id="nameInput">
        </div>
        
        <div class="form-group">
          <label class="form-label" id="labelJobTitle"><i class="material-icons">work</i> Job Title</label>
          <input type="text" class="form-input" id="jobTitleInput">
        </div>
        
        <div class="form-group">
          <label class="form-label" id="labelDepartment"><i class="material-icons">domain</i> Department</label>
          <input type="text" class="form-input" id="departmentInput">
        </div>
        
        <div class="form-group">
          <label class="form-label" id="labelPhone"><i class="material-icons">phone</i> Tel</label>
          <input type="text" class="form-input" id="phoneInput">
        </div>

        <div class="form-group">
          <label class="form-label" id="labelMobile"><i class="material-icons">smartphone</i> Mobile</label>
          <input type="text" class="form-input" id="mobileInput">
        </div>
        
        <div class="form-group">
          <label class="form-label" id="labelFax"><i class="material-icons">print</i> Fax</label>
          <input type="text" class="form-input" id="faxInput">
        </div>
        
        <div class="form-group">
          <label class="form-label" id="labelEmail"><i class="material-icons">email</i> Email</label>
          <input type="email" class="form-input" id="emailInput">
        </div>
        
        <div class="form-group">
          <label class="form-label" id="labelCompany"><i class="material-icons">apartment</i> Company Name</label>
          <input type="text" class="form-input" id="companyInput">
        </div>
        
        <div class="form-group">
          <label class="form-label" id="labelAddress"><i class="material-icons">place</i> Company Address</label>
          <input type="text" class="form-input" id="addressInput">
        </div>
        
        <div class="form-group">
          <label class="form-label" id="labelWebsite"><i class="material-icons">language</i> Company Website</label>
          <input type="url" class="form-input" id="websiteInput">
        </div>

        <!-- ADDED NOTE FIELD HERE -->
        <div class="form-group">
          <label class="form-label" id="labelNote"><i class="material-icons">note</i> Note</label>
          <textarea class="form-input" id="noteInput" rows="2"></textarea>
        </div>
        
        <div class="form-group" id="taxIdField" style="display: none;">
          <label class="form-label" id="labelTaxId"><i class="material-icons">confirmation_number</i> 統一編號 </label>
          <input type="text" class="form-input" id="taxIdInput">
        </div>
        
        <!-- Action Buttons -->
        <button class="btn btn-primary btn-xl" onclick="saveCard()" style="margin-bottom: 10px;">
          <span id="btnSave"><i class="material-icons">save</i> Save</span>
        </button>
        
        <button class="btn btn-secondary btn-large" onclick="rescan()" style="margin-bottom: 10px;">
          <span id="btnRescan"><i class="material-icons">refresh</i> Rescan</span>
        </button>
        
        <button class="btn btn-success btn-large" onclick="exportHistoryToExcel()">
          <span id="btnExport"><i class="material-icons">file_download</i> Export All</span>
        </button>
      </div>

      <!-- Language Selector -->
      <div class="language-selector">
        <select id="languageSelect" onchange="changeLanguage()">
          <option value="en">English</option>
          <option value="de">Deutsch</option>
          <option value="nl">Nederlands</option>
          <option value="jp">日本語</option>
          <option value="kr">한국어</option>
          <option value="sc">简体中文</option>
          <option value="tc">繁體中文</option>
        </select>
      </div>

    </div>
    
    <!-- Footer -->
    <div class="footer">
      <p>Copyright © Transcend Information, Inc. All Rights Reserved.</p>
    </div>
  </div>
  
  <script>
    let currentImage = null;
    let currentImageFile = null;
    let currentLanguage = 'en';
    
    // Azure AI Vision Configuration 
    const AZURE_ENDPOINT_ENCODED = 'aHR0cHM6Ly9taXNidXNpbmVzc2NhcmRvY3IuY29nbml0aXZlc2VydmljZXMuYXp1cmUuY29tLw==';
    const AZURE_API_KEY_ENCODED = 'RUdBTGljR0NiWldwdGoxRjNTRG9idjJQMVZ4QThxejFMdXJVcUdSQjNnY0E3eENxTWZPeEpRUUo5OUJMQUN4Q0NzeVhKM3czQUFBTEFDT0c0cmgz';
    
    // Decode credentials
    const AZURE_ENDPOINT = atob(AZURE_ENDPOINT_ENCODED);
    const AZURE_API_KEY = atob(AZURE_API_KEY_ENCODED);
    
    const translations = {
      en: {
        title: 'Transcend Business Name Card Scanner',
        previewText: 'Click to upload a business card',
        btnCamera: '<i class="material-icons">photo_camera</i> Camera',
        loadingText: '<i class="material-icons">document_scanner</i> Scanning business card, please wait...',
        progressText: 'Loading...',
        formTitle: '<i class="material-icons">assignment</i> Scan Results',
        labelName: '<i class="material-icons">person</i> Name',
        labelJobTitle: '<i class="material-icons">work</i> Job Title',
        labelDepartment: '<i class="material-icons">domain</i> Department',
        labelPhone: '<i class="material-icons">phone</i> Tel',
        labelMobile: '<i class="material-icons">smartphone</i> Mobile',
        labelFax: '<i class="material-icons">print</i> Fax',
        labelEmail: '<i class="material-icons">email</i> Email',
        labelCompany: '<i class="material-icons">apartment</i> Company',
        labelAddress: '<i class="material-icons">place</i> Company Address',
        labelWebsite: '<i class="material-icons">language</i> Company Website',
        labelNote: '<i class="material-icons">note</i> Note',
        labelTaxId: '<i class="material-icons">confirmation_number</i> Tax ID',
        btnSave: '<i class="material-icons">save</i> Save',
        btnRescan: '<i class="material-icons">refresh</i> Rescan',
        btnExport: '<i class="material-icons">file_download</i> Export All',
        alertImageLoaded: '<i class="material-icons">check_circle</i> Image loaded',
        alertUploadFirst: '<i class="material-icons">error</i> Please upload an image first',
        alertNoAzureConfig: '<i class="material-icons">error</i> Please configure Azure AI Vision credentials first',
        alertScanComplete: '<i class="material-icons">check_circle</i> Scan completed! Please check and correct the data',
        alertScanFailed: '<i class="material-icons">error</i> Scan failed: ',
        alertNoImage: '<i class="material-icons">error</i> No image to rescan',
        alertFillField: '<i class="material-icons">error</i> Please fill in at least one field',
        alertExcelDownloaded: '<i class="material-icons">check_circle</i> Excel file downloaded: ',
        alertSaved: '<i class="material-icons">save</i> Data saved to local storage',
        alertNoHistory: '<i class="material-icons">error</i> No history data found in storage',
        confirmSave: 'Save current data and clear for next card?',
        confirmRescan: 'Are you sure you want to rescan? Recognition results will be overwritten.',
        scanProgress: 'Scanning progress: '
      },
      de: {
        title: 'Transcend Visitenkarten-Scanner',
        previewText: 'Klicken Sie hier, um eine Visitenkarte hochzuladen',
        btnCamera: '<i class="material-icons">photo_camera</i> Kamera',
        loadingText: '<i class="material-icons">document_scanner</i> Visitenkarte wird gescannt, bitte warten...',
        progressText: 'Wird geladen...',
        formTitle: '<i class="material-icons">assignment</i> Scanergebnisse',
        labelName: '<i class="material-icons">person</i> Name',
        labelJobTitle: '<i class="material-icons">work</i> Berufsbezeichnung',
        labelDepartment: '<i class="material-icons">domain</i> Abteilung',
        labelPhone: '<i class="material-icons">phone</i> Tel',
        labelMobile: '<i class="material-icons">smartphone</i> Handy',
        labelFax: '<i class="material-icons">print</i> Fax',
        labelEmail: '<i class="material-icons">email</i> E-Mail',
        labelCompany: '<i class="material-icons">apartment</i> Firma',
        labelAddress: '<i class="material-icons">place</i> Firmenadresse',
        labelWebsite: '<i class="material-icons">language</i> Webseite',
        labelNote: '<i class="material-icons">note</i> Notiz',
        labelTaxId: '<i class="material-icons">confirmation_number</i> Steuernummer',
        btnSave: '<i class="material-icons">save</i> Speichern',
        btnRescan: '<i class="material-icons">refresh</i> Neu scannen',
        btnExport: '<i class="material-icons">file_download</i> Alle exportieren',
        alertImageLoaded: '<i class="material-icons">check_circle</i> Bild geladen.',
        alertUploadFirst: '<i class="material-icons">error</i> Bitte laden Sie zuerst ein Bild hoch',
        alertNoAzureConfig: '<i class="material-icons">error</i> Bitte konfigurieren Sie zuerst die Azure AI Vision-Anmeldeinformationen',
        alertScanComplete: '<i class="material-icons">check_circle</i> Scan abgeschlossen! Bitte überprüfen und korrigieren Sie die Daten',
        alertScanFailed: '<i class="material-icons">error</i> Scan fehlgeschlagen: ',
        alertNoImage: '<i class="material-icons">error</i> Kein Bild zum erneuten Scannen',
        alertFillField: '<i class="material-icons">error</i> Bitte füllen Sie mindestens ein Feld aus',
        alertExcelDownloaded: '<i class="material-icons">check_circle</i> Excel-Datei heruntergeladen: ',
        alertSaved: '<i class="material-icons">save</i> Daten im lokalen Speicher gespeichert',
        alertNoHistory: '<i class="material-icons">error</i> Keine Verlaufsdaten im Speicher gefunden',
        confirmSave: 'Aktuelle Daten speichern und für nächste Karte löschen?',
        confirmRescan: 'Möchten Sie wirklich neu scannen? Erkennungsergebnisse werden überschrieben.',
        scanProgress: 'Scan-Fortschritt: '
      },
      nl: {
        title: 'Transcend Visitekaartje Scanner',
        previewText: 'Klik om een visitekaartje te uploaden',
        btnCamera: '<i class="material-icons">photo_camera</i> Camera',
        loadingText: '<i class="material-icons">document_scanner</i> Visitekaartje wordt gescand, even geduld...',
        progressText: 'Laden...',
        formTitle: '<i class="material-icons">assignment</i> Scanresultaten',
        labelName: '<i class="material-icons">person</i> Naam',
        labelJobTitle: '<i class="material-icons">work</i> Functietitel',
        labelDepartment: '<i class="material-icons">domain</i> Afdeling',
        labelPhone: '<i class="material-icons">phone</i> Tel',
        labelMobile: '<i class="material-icons">smartphone</i> Mobiel',
        labelFax: '<i class="material-icons">print</i> Fax',
        labelEmail: '<i class="material-icons">email</i> E-mail',
        labelCompany: '<i class="material-icons">apartment</i> Bedrijf',
        labelAddress: '<i class="material-icons">place</i> Bedrijfsadres',
        labelWebsite: '<i class="material-icons">language</i> Website',
        labelNote: '<i class="material-icons">note</i> Notitie',
        labelTaxId: '<i class="material-icons">confirmation_number</i> BTW-nummer',
        btnSave: '<i class="material-icons">save</i> Opslaan',
        btnRescan: '<i class="material-icons">refresh</i> Opnieuw scannen',
        btnExport: '<i class="material-icons">file_download</i> Alles exporteren',
        alertImageLoaded: '<i class="material-icons">check_circle</i> Afbeelding geladen.',
        alertUploadFirst: '<i class="material-icons">error</i> Upload eerst een afbeelding',
        alertNoAzureConfig: '<i class="material-icons">error</i> Configureer eerst de Azure AI Vision-referenties',
        alertScanComplete: '<i class="material-icons">check_circle</i> Scan voltooid! Controleer en corrigeer de gegevens',
        alertScanFailed: '<i class="material-icons">error</i> Scan mislukt: ',
        alertNoImage: '<i class="material-icons">error</i> Geen afbeelding om opnieuw te scannen',
        alertFillField: '<i class="material-icons">error</i> Vul minimaal één veld in',
        alertExcelDownloaded: '<i class="material-icons">check_circle</i> Excel-bestand gedownload: ',
        alertSaved: '<i class="material-icons">save</i> Gegevens opgeslagen in lokale opslag',
        alertNoHistory: '<i class="material-icons">error</i> Geen geschiedenisgegevens gevonden',
        confirmSave: 'Huidige gegevens opslaan en wissen voor volgende kaart?',
        confirmRescan: 'Weet u zeker dat u opnieuw wilt scannen? Herkenningsresultaten worden overschreven.',
        scanProgress: 'Scanvoortgang: '
      },
      jp: {
        title: 'Transcend 名刺スキャナー',
        previewText: 'クリックして名刺をアップロード',
        btnCamera: '<i class="material-icons">photo_camera</i> カメラ',
        loadingText: '<i class="material-icons">document_scanner</i> 名刺をスキャン中です。お待ちください...',
        progressText: '読み込み中...',
        formTitle: '<i class="material-icons">assignment</i> スキャン結果',
        labelName: '<i class="material-icons">person</i> 名前',
        labelJobTitle: '<i class="material-icons">work</i> 役職',
        labelDepartment: '<i class="material-icons">domain</i> 部署',
        labelPhone: '<i class="material-icons">phone</i> 電話 (Tel)',
        labelMobile: '<i class="material-icons">smartphone</i> 携帯電話',
        labelFax: '<i class="material-icons">print</i> FAX',
        labelEmail: '<i class="material-icons">email</i> メール',
        labelCompany: '<i class="material-icons">apartment</i> 会社',
        labelAddress: '<i class="material-icons">place</i> 会社住所',
        labelWebsite: '<i class="material-icons">language</i> ウェブサイト',
        labelNote: '<i class="material-icons">note</i> メモ',
        labelTaxId: '<i class="material-icons">confirmation_number</i> 法人番号',
        btnSave: '<i class="material-icons">save</i> 保存',
        btnRescan: '<i class="material-icons">refresh</i> 再スキャン',
        btnExport: '<i class="material-icons">file_download</i> 全てエクスポート',
        alertImageLoaded: '<i class="material-icons">check_circle</i> 画像が読み込まれました。',
        alertUploadFirst: '<i class="material-icons">error</i> 最初に画像をアップロードしてください',
        alertNoAzureConfig: '<i class="material-icons">error</i> まずAzure AI Visionの認証情報を設定してください',
        alertScanComplete: '<i class="material-icons">check_circle</i> スキャン完了！データを確認して修正してください',
        alertScanFailed: '<i class="material-icons">error</i> スキャン失敗: ',
        alertNoImage: '<i class="material-icons">error</i> 再スキャンする画像がありません',
        alertFillField: '<i class="material-icons">error</i> 少なくとも1つのフィールドを入力してください',
        alertExcelDownloaded: '<i class="material-icons">check_circle</i> Excelファイルをダウンロードしました: ',
        alertSaved: '<i class="material-icons">save</i> データはローカルストレージに保存されました',
        alertNoHistory: '<i class="material-icons">error</i> 履歴データが見つかりません',
        confirmSave: '現在のデータを保存して、次のカードのためにクリアしますか？',
        confirmRescan: '再スキャンしてもよろしいですか？認識結果は上書きされます。',
        scanProgress: 'スキャン進行状況: '
      },
      kr: {
        title: 'Transcend 명함 스캐너',
        previewText: '클릭하여 명함 업로드',
        btnCamera: '<i class="material-icons">photo_camera</i> 카메라',
        loadingText: '<i class="material-icons">document_scanner</i> 명함을 스캔하고 있습니다. 잠시만 기다려주세요...',
        progressText: '로딩 중...',
        formTitle: '<i class="material-icons">assignment</i> 스캔 결과',
        labelName: '<i class="material-icons">person</i> 이름',
        labelJobTitle: '<i class="material-icons">work</i> 직책',
        labelDepartment: '<i class="material-icons">domain</i> 부서',
        labelPhone: '<i class="material-icons">phone</i> 전화 (Tel)',
        labelMobile: '<i class="material-icons">smartphone</i> 휴대전화',
        labelFax: '<i class="material-icons">print</i> 팩스',
        labelEmail: '<i class="material-icons">email</i> 이메일',
        labelCompany: '<i class="material-icons">apartment</i> 회사',
        labelAddress: '<i class="material-icons">place</i> 회사 주소',
        labelWebsite: '<i class="material-icons">language</i> 웹사이트',
        labelNote: '<i class="material-icons">note</i> 메모',
        labelTaxId: '<i class="material-icons">confirmation_number</i> 사업자등록번호',
        btnSave: '<i class="material-icons">save</i> 저장',
        btnRescan: '<i class="material-icons">refresh</i> 다시 스캔',
        btnExport: '<i class="material-icons">file_download</i> 전체 내보내기',
        alertImageLoaded: '<i class="material-icons">check_circle</i> 이미지가 로드되었습니다.',
        alertUploadFirst: '<i class="material-icons">error</i> 먼저 이미지를 업로드하세요',
        alertNoAzureConfig: '<i class="material-icons">error</i> 먼저 Azure AI Vision 자격 증명을 구성하세요',
        alertScanComplete: '<i class="material-icons">check_circle</i> 스캔 완료! 데이터를 확인하고 수정하세요',
        alertScanFailed: '<i class="material-icons">error</i> 스캔 실패: ',
        alertNoImage: '<i class="material-icons">error</i> 다시 스캔할 이미지가 없습니다',
        alertFillField: '<i class="material-icons">error</i> 최소한 하나의 필드를 입력하세요',
        alertExcelDownloaded: '<i class="material-icons">check_circle</i> Excel 파일 다운로드됨: ',
        alertSaved: '<i class="material-icons">save</i> 데이터가 로컬 저장소에 저장되었습니다',
        alertNoHistory: '<i class="material-icons">error</i> 저장소에서 기록 데이터를 찾을 수 없습니다',
        confirmSave: '현재 데이터를 저장하고 다음 카드를 위해 지우시겠습니까?',
        confirmRescan: '다시 스캔하시겠습니까? 인식 결과가 덮어쓰기됩니다.',
        scanProgress: '스캔 진행률: '
      },
      sc: {
        title: 'Transcend 名片扫描工具',
        previewText: '点击上传名片',
        btnCamera: '<i class="material-icons">photo_camera</i> 拍照',
        loadingText: '<i class="material-icons">document_scanner</i> 正在识别名片，请稍候...',
        progressText: '加载中...',
        formTitle: '<i class="material-icons">assignment</i> 识别结果',
        labelName: '<i class="material-icons">person</i> 姓名',
        labelJobTitle: '<i class="material-icons">work</i> 职位',
        labelDepartment: '<i class="material-icons">domain</i> 部门',
        labelPhone: '<i class="material-icons">phone</i> 电话 (Tel)',
        labelMobile: '<i class="material-icons">smartphone</i> 手机',
        labelFax: '<i class="material-icons">print</i> 传真',
        labelEmail: '<i class="material-icons">email</i> 邮箱',
        labelCompany: '<i class="material-icons">apartment</i> 公司',
        labelAddress: '<i class="material-icons">place</i> 公司地址',
        labelWebsite: '<i class="material-icons">language</i> 公司网站',
        labelNote: '<i class="material-icons">note</i> 备注',
        labelTaxId: '<i class="material-icons">confirmation_number</i> 统一社会信用代码',
        btnSave: '<i class="material-icons">save</i> 保存',
        btnRescan: '<i class="material-icons">refresh</i> 重新扫描',
        btnExport: '<i class="material-icons">file_download</i> 导出所有',
        alertImageLoaded: '<i class="material-icons">check_circle</i> 图片已加载',
        alertUploadFirst: '<i class="material-icons">error</i> 请先上传图片',
        alertNoAzureConfig: '<i class="material-icons">error</i> 请先配置Azure AI Vision凭据',
        alertScanComplete: '<i class="material-icons">check_circle</i> 识别完成！请检查并修正数据',
        alertScanFailed: '<i class="material-icons">error</i> 识别失败：',
        alertNoImage: '<i class="material-icons">error</i> 没有可重新扫描的图片',
        alertFillField: '<i class="material-icons">error</i> 请至少填写一个字段',
        alertExcelDownloaded: '<i class="material-icons">check_circle</i> Excel文件已下载：',
        alertSaved: '<i class="material-icons">save</i> 数据已保存到本地存储',
        alertNoHistory: '<i class="material-icons">error</i> 未找到历史记录',
        confirmSave: '保存当前数据并清空以进行下一次扫描？',
        confirmRescan: '确定要重新扫描吗？识别结果将被覆盖。',
        scanProgress: '识别进度：'
      },
      tc: {
        title: 'Transcend 名片掃描工具',
        previewText: '點擊上傳名片',
        btnCamera: '<i class="material-icons">photo_camera</i> 拍照',
        loadingText: '<i class="material-icons">document_scanner</i> 正在辨識名片，請稍候...',
        progressText: '載入中...',
        formTitle: '<i class="material-icons">assignment</i> 辨識結果',
        labelName: '<i class="material-icons">person</i> 姓名',
        labelJobTitle: '<i class="material-icons">work</i> 職稱',
        labelDepartment: '<i class="material-icons">domain</i> 部門',
        labelPhone: '<i class="material-icons">phone</i> Tel',
        labelMobile: '<i class="material-icons">smartphone</i> Mobile',
        labelFax: '<i class="material-icons">print</i> 傳真',
        labelEmail: '<i class="material-icons">email</i> 電子郵件',
        labelCompany: '<i class="material-icons">apartment</i> 公司',
        labelAddress: '<i class="material-icons">place</i> 公司地址',
        labelWebsite: '<i class="material-icons">language</i> 公司網站',
        labelNote: '<i class="material-icons">note</i> 備註',
        labelTaxId: '<i class="material-icons">confirmation_number</i> 統一編號',
        btnSave: '<i class="material-icons">save</i> 儲存',
        btnRescan: '<i class="material-icons">refresh</i> 重新掃描',
        btnExport: '<i class="material-icons">file_download</i> 匯出所有',
        alertImageLoaded: '<i class="material-icons">check_circle</i> 圖片已載入',
        alertUploadFirst: '<i class="material-icons">error</i> 請先上傳圖片',
        alertNoAzureConfig: '<i class="material-icons">error</i> 請先設定Azure AI Vision憑證',
        alertScanComplete: '<i class="material-icons">check_circle</i> 辨識完成！請檢查並修正資料',
        alertScanFailed: '<i class="material-icons">error</i> 辨識失敗：',
        alertNoImage: '<i class="material-icons">error</i> 沒有可重新掃描的圖片',
        alertFillField: '<i class="material-icons">error</i> 請至少填寫一個欄位',
        alertExcelDownloaded: '<i class="material-icons">check_circle</i> Excel檔案已下載：',
        alertSaved: '<i class="material-icons">save</i> 資料已儲存至 Local Storage',
        alertNoHistory: '<i class="material-icons">error</i> 查無歷史紀錄',
        confirmSave: '儲存目前資料並清空以進行下一次掃描？',
        confirmRescan: '確定要重新掃描嗎？辨識結果將被覆蓋。',
        scanProgress: '辨識進度：'
      }
    };
    
    function changeLanguage() {
      const lang = document.getElementById('languageSelect').value;
      currentLanguage = lang;
      const t = translations[lang];
      
      // Use innerHTML instead of textContent to render icons
      document.getElementById('headerTitle').textContent = t.title;
      document.getElementById('btnCamera').innerHTML = t.btnCamera;
      document.getElementById('loadingText').innerHTML = t.loadingText;
      document.getElementById('formTitle').innerHTML = t.formTitle;
      document.getElementById('labelName').innerHTML = t.labelName;
      document.getElementById('labelJobTitle').innerHTML = t.labelJobTitle;
      document.getElementById('labelDepartment').innerHTML = t.labelDepartment;
      document.getElementById('labelPhone').innerHTML = t.labelPhone;
      document.getElementById('labelMobile').innerHTML = t.labelMobile;
      document.getElementById('labelFax').innerHTML = t.labelFax;
      document.getElementById('labelEmail').innerHTML = t.labelEmail;
      document.getElementById('labelCompany').innerHTML = t.labelCompany;
      document.getElementById('labelAddress').innerHTML = t.labelAddress;
      document.getElementById('labelWebsite').innerHTML = t.labelWebsite;
      document.getElementById('labelNote').innerHTML = t.labelNote; 
      document.getElementById('labelTaxId').innerHTML = t.labelTaxId;
      document.getElementById('btnSave').innerHTML = t.btnSave;
      document.getElementById('btnRescan').innerHTML = t.btnRescan;
      
      // Update Export Button with Count
      updateExportButton();

      // Show/hide Tax ID field based on language
      const taxIdField = document.getElementById('taxIdField');
      if (lang === 'tc') {
        taxIdField.style.display = 'block';
      } else {
        taxIdField.style.display = 'none';
      }
      
      // Update preview text if no image loaded
      if (!currentImage) {
        const previewBox = document.getElementById('previewBox');
        if (previewBox.querySelector('.preview-placeholder')) {
          previewBox.querySelector('p').textContent = t.previewText;
        }
      }
    }

    // Helper function to update the Export Button with the count
    function updateExportButton() {
      const history = JSON.parse(localStorage.getItem('businessCardHistory') || '[]');
      const count = history.length;
      const t = translations[currentLanguage];
      document.getElementById('btnExport').innerHTML = `${t.btnExport} (${count})`;
    }
    
    function openCamera() {
      document.getElementById('cameraInput').click();
    }
    
    // Prevent triggering file input when clicking on OCR boxes
    function triggerFileInput(event) {
        if(event.target.classList.contains('ocr-box')) return;
        document.getElementById('fileInput').click();
    }
    
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      currentImageFile = file;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        currentImage = e.target.result;
        displayImage(currentImage);
        showAlert('success', translations[currentLanguage].alertImageLoaded);

        // Automatically start OCR after image is loaded
        setTimeout(() => {
          performOCR();
        }, 500);
      };
      reader.readAsDataURL(file);
    }
    
    function displayImage(imageSrc) {
      const previewBox = document.getElementById('previewBox');
      // Create a relative container for image and overlays
      previewBox.innerHTML = `
        <div id="imageWrapper">
            <img id="previewImage" src="${imageSrc}" alt="Business Card Preview">
            <div id="overlayLayer"></div>
        </div>
      `;
    }   
    
    async function performOCR() {
      if (!currentImage) {
        showAlert('error', translations[currentLanguage].alertUploadFirst);
        return;
      }      
      const loadingDiv = document.getElementById('loadingDiv');
      const progressText = document.getElementById('progressText');
      loadingDiv.classList.add('show');
      progressText.textContent = translations[currentLanguage].progressText;
            
      try {
        // Convert base64 to blob
        const base64Data = currentImage.split(',')[1];
        const byteCharacters = atob(base64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'image/jpeg' });
        
        // Azure Document Intelligence (prebuilt-read) endpoint
        const apiUrl = `${AZURE_ENDPOINT.replace(/\/$/, '')}/documentintelligence/documentModels/prebuilt-read:analyze?api-version=2024-11-30`;
        
        // Submit image for analysis
        const submitResponse = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Ocp-Apim-Subscription-Key': AZURE_API_KEY,
            'Content-Type': 'application/octet-stream'
          },
          body: blob
        });
        
        if (!submitResponse.ok) {
          const errText = await submitResponse.text();
          throw new Error(`Azure API error: ${submitResponse.status} ${submitResponse.statusText} - ${errText}`);
        }
        
        // Get operation location from response headers
        const operationLocation = submitResponse.headers.get('Operation-Location');
        if (!operationLocation) {
          throw new Error('No Operation-Location header in response');
        }
        
        // Poll for results
        let result;
        let attempts = 0;
        const maxAttempts = 30;
        
        while (attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          const resultResponse = await fetch(operationLocation, {
            method: 'GET',
            headers: {
              'Ocp-Apim-Subscription-Key': AZURE_API_KEY
            }
          });
          
          if (!resultResponse.ok) {
            throw new Error(`Failed to get results: ${resultResponse.status}`);
          }
          
          result = await resultResponse.json();
          
          if (result.status === 'succeeded') {
            break;
          } else if (result.status === 'failed') {
            throw new Error('OCR analysis failed');
          }
          
          attempts++;
          progressText.textContent = `${translations[currentLanguage].progressText} (${attempts}/${maxAttempts})`;
        }
        
        if (result.status !== 'succeeded') {
          throw new Error('OCR timeout');
        }
        
        // Extract text from results
        let extractedText = '';
        if (result.analyzeResult && result.analyzeResult.pages) {
          for (const page of result.analyzeResult.pages) {
            if (page.lines) {
              for (const line of page.lines) {
                extractedText += line.content + '\n';
              }
            }
          }
        } else if (result.analyzeResult && result.analyzeResult.content) {
             extractedText = result.analyzeResult.content;
        }
        
        // Draw OCR Overlay
        drawOCROverlay(result);

        parseOCRResult(extractedText);
        
        loadingDiv.classList.remove('show');
        showAlert('success', translations[currentLanguage].alertScanComplete);
      } catch (error) {
        loadingDiv.classList.remove('show');
        showAlert('error', translations[currentLanguage].alertScanFailed + error.message);
      }
    }

    // Function to draw OCR bounding boxes
    function drawOCROverlay(result) {
        const overlayLayer = document.getElementById('overlayLayer');
        const img = document.getElementById('previewImage');
        
        if(!overlayLayer || !img || !result.analyzeResult) return;
        
        overlayLayer.innerHTML = ''; // Clear existing
        
        // We need to wait for the image to load to get its display dimensions
        // If image is already loaded:
        if (img.complete) {
            renderBoxes();
        } else {
            img.onload = renderBoxes;
        }

        function renderBoxes() {
            // Azure coordinates are usually based on original image size
            // We need to scale them to the displayed image size
            const naturalWidth = img.naturalWidth;
            const naturalHeight = img.naturalHeight;
            const displayWidth = img.width;
            const displayHeight = img.height;
            
            const scaleX = displayWidth / naturalWidth;
            const scaleY = displayHeight / naturalHeight;

            const pages = result.analyzeResult.pages;
            if(!pages) return;

            pages.forEach(page => {
               if(page.lines) {
                   page.lines.forEach(line => {
                       // polygon: [x1, y1, x2, y2, x3, y3, x4, y4]
                       // Simple bounding box logic (min x, min y, width, height)
                       const p = line.polygon;
                       if (!p) return;

                       // Calculate bounding box from polygon
                       const xs = [p[0], p[2], p[4], p[6]];
                       const ys = [p[1], p[3], p[5], p[7]];
                       
                       const minX = Math.min(...xs);
                       const minY = Math.min(...ys);
                       const maxX = Math.max(...xs);
                       const maxY = Math.max(...ys);
                       
                       const box = document.createElement('div');
                       box.className = 'ocr-box';
                       box.style.left = (minX * scaleX) + 'px';
                       box.style.top = (minY * scaleY) + 'px';
                       box.style.width = ((maxX - minX) * scaleX) + 'px';
                       box.style.height = ((maxY - minY) * scaleY) + 'px';
                       
                       // Set hover text
                       box.setAttribute('data-text', line.content);
                       
                       overlayLayer.appendChild(box);
                   });
               } 
            });
        }
    }

    function guessName(lines, jobTitleIndex = -1) {
    // 1. 擴充排除關鍵字：包含產業別、公司型態、常見標語
    const excludeKeywords = [
        '公司', '有限公司', '股份', '集團', '工作室', '企業', '商行', '中心', 
        'Inc', 'Ltd', 'Corp', 'Group', 'LLC', 'Co.', 'Company', 'Enterprise', 'Department', 'Dept', 'Div', 'Division', 'Team', 'Center', '部門', '部', '課', 'BU', '處', '中心',
        '路', '號', '樓', '室', '區', '縣', '市', 'City', 'Street', 'Road', 'Ave', 'Dist',
        'Tel', 'Fax', 'Mobile', 'Email', 'Web', 'www', 'http', '.com', '.tw', '統一編號', '統編', 'TAX',
        '科技', '資訊', '實業', '工業', '貿易', '國際', '電子', '生技', '文化', '創意', '設計', '物流', 
        'Technology', 'System', 'Global', 'Digital', 'Consulting', 'Solutions', 'Industry', 'International'
    ];

    // 常見職稱 (用於從同一行移除)
    const jobTitles = [
        '經理', '副理', '總監', '主任', '專員', '工程師','處長','董事長','負責人', '執行長', '董事', '特助', '顧問', '代表',
        'CEO', 'CTO', 'CFO', 'COO', 'Manager', 'Director', 'Engineer', 'President', 'Founder', 'Specialist', 'Assistant', 'Chief',           
    ];

    // --- 策略 A: 職稱錨點 (Anchor Strategy) ---
    // 如果已知職稱在哪一行 (jobTitleIndex)，優先檢查該行的上下一行
    if (jobTitleIndex > 0) {
        let prevLine = lines[jobTitleIndex - 1].trim();        
        let isBlockedprevLine = excludeKeywords.some(k => prevLine.toLowerCase().includes(k.toLowerCase()));
        let hasNumberprevLine = /\d/.test(prevLine);
        
        if (!isBlockedprevLine && !hasNumberprevLine && prevLine.length >= 2 && excludeKeywords.some(keyword => prevLine.toLowerCase().includes(keyword.toLowerCase()))) {
              return prevLine;             
        }

        let nextLine = lines[jobTitleIndex + 1].trim();
        let isBlockednextLine = excludeKeywords.some(k => nextLine.toLowerCase().includes(k.toLowerCase()));
        let hasNumbernextLine = /\d/.test(nextLine);

        if (!isBlockednextLine && !hasNumbernextLine && nextLine.length >= 2 && excludeKeywords.some(keyword => nextLine.toLowerCase().includes(keyword.toLowerCase()))) {
              return nextLine;             
        }
    }

    // --- 策略 B: 全局掃描 (Fallback) ---
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();

        // 過濾 1: 基本雜訊
        if (line.length < 2 || line.includes('@') || /\d/.test(line)) continue;

        // 過濾 2: 關鍵字排除
        if (excludeKeywords.some(keyword => line.toLowerCase().includes(keyword.toLowerCase()))) continue;

        // 過濾 3: 職稱處理 (同一行)
        const matchedTitle = jobTitles.find(title => line.toLowerCase().includes(title.toLowerCase()));
        if (matchedTitle) {
            let possibleName = line.replace(matchedTitle, '').trim();
            possibleName = possibleName.replace(/[\|\-,\.]/g, '').trim(); // 移除標點
            
            // 嚴格檢查剩餘文字
            if (possibleName.length >= 2 && possibleName.length <= 15) {
                 // 如果是中文，長度大於4通常是"XX科技股份有限公司"移除職稱後的殘留
                 if (/[\u4e00-\u9fa5]/.test(possibleName) && possibleName.length > 4) continue;
                 return possibleName;
            }
        } 
        
        // 過濾 4: 純名字猜測 (通常在前 5 行)
        if (i < 5) {
             // 中文名字嚴格限制 2-4 字
             if (/[\u4e00-\u9fa5]/.test(line)) {
                 if (line.length >= 2 && line.length <= 4) return line;
             } 
             // 英文名字 排除全大寫小寫或全是連結符號的
             else {
                 if (line.length >= 3 && line.length <= 20 && !/^[a-z]+$/.test(line) && !/^[A-Z]+$/.test(line)) {
                     return line;
                 }
             }
        }
    }
    return "";
    }
    
    function extractGlobalPhoneNumber(line) {
    // 移除常見的干擾字元，但保留數字、+、-、.、()、空格
    // 這是為了支援美國 (123.456.7890) 和 國際 (+886 2 2792 8000)
    
    // Regex ：
    // ((\+|00)\d{1,4})?  -> 可選的國碼，如 +886 或 00886
    // [\s\-\.]?          -> 分隔符
    // \(?\d{1,5}\)?      -> 區碼或前綴，可能帶括號 (02)
    // ... 後續的數字群組
    
    // 這個 Regex 可以匹配：
    // TW: 0912-345-678, (02) 2792-8000
    // US: 555.123.4567, +1-555-555-5555
    // CN: +86 138 1234 5678
    // DE: +49 30 123456
    // JP: 03-1234-5678
    
    const globalPhoneRegex = /(?:(?:\+|00)\d{1,4}[\s\-\.]*)?(?:\(?\d{1,5}\)?[\s\-\.]*){1,5}\d{3,}/g;
    
    const matches = line.match(globalPhoneRegex);
    if (!matches) return null;

    // 從匹配結果中找出最像電話號碼的 (長度檢查)
    // 過濾掉太短的 (可能是分機號碼或門牌) 或太長的
    for (let match of matches) {
        // 計算純數字長度
        const digitCount = match.replace(/\D/g, '').length;
        
        // 國際電話通常至少 8 碼 (包含區碼)，最多約 15 碼 (ITU標準)
        // 台灣手機 10 碼，市話+區碼 9-10 碼
        // 香港 8 碼
        if (digitCount >= 8 && digitCount <= 17) {
            return match.trim();
        }
    }
    return null;
}
    
    function parseOCRResult(text) {
    const lines = text.split('\n').filter(line => line.trim());
    
    let name = '';
    let jobTitle = '';
    let department = '';
    let phone = '';
    let mobile = '';
    let fax = '';
    let email = '';
    let company = '';
    let address = '';
    let website = '';
    let taxId = '';

    // 定義多國語言的關鍵字
    const keywords = {
        mobile: ['Mobile', 'Mob', 'Cell', 'Handy', 'M:', 'M.', '行動', '手機', '手提', '+'],
        phone: ['Tel', 'Phone', 'Ph', 'Office', 'T:', 'T.', 'D:', '電話', '代表', '+'],
        address: ['路', '號', '樓', '室', '區', '縣', '市', 'City', 'Country', 'Street', 'Road', 'Rd.', 'Ave', 'Dist.', 'No.', 'Taiwan'],
        fax: ['Fax', 'F:', 'F.', '傳真'],
        email: ['@'],
        website: ['http', 'www.', '.com', '.tw', '.cn', '.jp', '.de', '.nl', '.fr', '.kr', '.net'],
        taxId: ['統一編號', '統編', 'Tax ID', 'VAT', 'GUI'], 
        company: ['Co.', 'Ltd', 'Inc', 'Corp', 'GmbH', 'AG', 'Group', 'Company', 'Limited', 'Technology', '公司', '集團', '株式會社', '株式会社'],
        dept: ['Department', 'Dept', 'Div', 'Division', 'Team', 'Center', 'BU', '處', '中心', '部門', '部', '課'],
        job: ['Manager', 'Director', 'Chief', 'Engineer', 'Specialist', 'Assistant' , 'President', 'CEO', 'Founder', 'CEO', 'CTO', 'CFO', 'COO',
              '經理', '副理', '總監', '主任', '專員', '工程師', '處長', '執行長', '董事', '董事長','特助', '顧問', '代表', '負責人']
    };  
    
    // 暫存職稱所在的行數索引
    let jobTitleIndex = -1;

    // 第一輪掃描：先找明確的欄位 (職稱、電話、Email、公司名)
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        let lineLower = line.toLowerCase();
      
        // Email
        const emailMatch = line.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
        if (emailMatch && !email) {
            email = emailMatch[0];
            continue;
        }

        // Website
        const websiteMatch = line.match(/(?:https?:\/\/)?(?:www\.)?[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(?:\/[^\s]*)?/);
        if (websiteMatch && !website && !line.includes('@')) {
            website = websiteMatch[0];
            continue;
        }

        // Mobile 
        if (keywords.mobile.some(k => line.includes(k) || lineLower.startsWith(k.toLowerCase()))) {
            if (!mobile) {
                const extracted = extractGlobalPhoneNumber(line);
                if (extracted) {
                    mobile = extracted;
                    continue; 
                }
            }
        }

        // Fax 
        if (keywords.fax.some(k => line.includes(k) || lineLower.startsWith(k.toLowerCase()))) {
            if (!fax) {
                const extracted = extractGlobalPhoneNumber(line);
                if (extracted) {
                    fax = extracted;
                    continue;
                }
            }
        }

        // Phone
        if (keywords.phone.some(k => line.includes(k) || lineLower.startsWith(k.toLowerCase()))) {
            if (!phone) {
                const extracted = extractGlobalPhoneNumber(line);
                if (extracted) {
                    phone = extracted;
                    continue;
                }
            }
        }

        // Tax ID
        const taxIdMatch = line.match(/\b\d{8}\b/);
        if (taxIdMatch && !taxId) {
            taxId = taxIdMatch[0];
            continue;
        }

        if (!jobTitle && keywords.job.some(k => line.includes(k))) {
            jobTitle = line;
            jobTitleIndex = i;
            continue;
        }
        if (!department && keywords.dept.some(k => line.includes(k))) {
            department = line;
            continue;
        }
        
        const isAllCaps = /^[A-Z.,&-]+$/.test(line) && line.length > 3;             
        if (!company && keywords.company.some(k => line.includes(k))) {
            company = line;
            continue;
        }else if (isAllCaps) {
            company = line;
            continue;
        }

        if (!address && line.length > 10 && keywords.address.some(k => line.includes(k) || lineLower.startsWith(k.toLowerCase()))){        
            address = line;
            continue;
        }
    }

    // 第二輪：如果還沒找到名字，利用職稱位置來猜
    if (!name) {
        name = guessName(lines, jobTitleIndex);
    }

    // 填入表單
    document.getElementById('nameInput').value = name;
    document.getElementById('jobTitleInput').value = jobTitle;
    document.getElementById('departmentInput').value = department;
    document.getElementById('phoneInput').value = phone;
    document.getElementById('mobileInput').value = mobile;
    document.getElementById('faxInput').value = fax;
    document.getElementById('emailInput').value = email;
    document.getElementById('companyInput').value = company;
    document.getElementById('addressInput').value = address;
    document.getElementById('websiteInput').value = website;
    document.getElementById('taxIdInput').value = taxId;
}
    
    // Save current form data to localStorage
    function saveToLocalStorage() {
      const cardData = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        name: document.getElementById('nameInput').value,
        jobTitle: document.getElementById('jobTitleInput').value,
        department: document.getElementById('departmentInput').value,
        phone: document.getElementById('phoneInput').value,
        mobile: document.getElementById('mobileInput').value,
        fax: document.getElementById('faxInput').value,
        email: document.getElementById('emailInput').value,
        company: document.getElementById('companyInput').value,
        address: document.getElementById('addressInput').value,
        website: document.getElementById('websiteInput').value,
        note: document.getElementById('noteInput').value, 
        taxId: document.getElementById('taxIdInput').value
      };
      
      // Get existing history or initialize empty array
      let history = JSON.parse(localStorage.getItem('businessCardHistory') || '[]');
      
      // Add new card to history
      history.push(cardData);
      
      // Save back to localStorage
      localStorage.setItem('businessCardHistory', JSON.stringify(history));
      
      console.log('Saved to localStorage:', cardData);
    }

    // Renamed from uploadNew to saveCard
    function saveCard() {
      // Check if there is any data in the form to save
      const hasData = [
        'nameInput', 'jobTitleInput', 'departmentInput', 'phoneInput', 'mobileInput',
        'faxInput', 'emailInput', 'companyInput', 'addressInput', 
        'websiteInput', 'noteInput', 'taxIdInput' 
      ].some(id => document.getElementById(id).value.trim() !== '');

      if (hasData) {
        saveToLocalStorage();
        showAlert('success', translations[currentLanguage].alertSaved);
        clearAll();
        // Update the export button count
        updateExportButton();
      } else {
        showAlert('error', translations[currentLanguage].alertFillField);
      }
    }
    
    function rescan() {
      if (!currentImage) {
        showAlert('error', translations[currentLanguage].alertNoImage);
        return;
      }
      
      if (confirm(translations[currentLanguage].confirmRescan)) {
        performOCR();
      }
    }
    
    function clearAll() {
      currentImage = null;
      currentImageFile = null;
      const t = translations[currentLanguage];
      document.getElementById('previewBox').innerHTML = `
        <div class="preview-placeholder">
          <i class="material-icons">add_a_photo</i>
          <p>${t.previewText}</p>
        </div>
      `;
      document.getElementById('nameInput').value = '';
      document.getElementById('jobTitleInput').value = '';
      document.getElementById('departmentInput').value = '';
      document.getElementById('phoneInput').value = '';
      document.getElementById('mobileInput').value = '';
      document.getElementById('faxInput').value = '';
      document.getElementById('emailInput').value = '';
      document.getElementById('companyInput').value = '';
      document.getElementById('addressInput').value = '';
      document.getElementById('websiteInput').value = '';
      document.getElementById('noteInput').value = ''; 
      document.getElementById('taxIdInput').value = '';
      document.getElementById('fileInput').value = '';
      document.getElementById('cameraInput').value = '';
    }
    
    // Updated function to export history from LocalStorage
    function exportHistoryToExcel() {
      // Retrieve history from local storage
      const historyJSON = localStorage.getItem('businessCardHistory');
      const history = JSON.parse(historyJSON || '[]');
      
      if (history.length === 0) {
        showAlert('error', translations[currentLanguage].alertNoHistory);
        return;
      }
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      
      // Get column headers based on current language by stripping HTML tags
      const t = translations[currentLanguage];
      const stripHtml = (html) => {
        const tmp = document.createElement("DIV");
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || "";
      };
      
      const headers = [
        stripHtml(t.labelName),
        stripHtml(t.labelJobTitle),
        stripHtml(t.labelDepartment),
        stripHtml(t.labelPhone),
        stripHtml(t.labelMobile),
        stripHtml(t.labelFax),
        stripHtml(t.labelEmail),
        stripHtml(t.labelCompany),
        stripHtml(t.labelAddress),
        stripHtml(t.labelWebsite),
        stripHtml(t.labelNote), 
        stripHtml(t.labelTaxId)
      ];
      
      // Map history data to array of arrays
      const dataRows = history.map(item => [
        item.name,
        item.jobTitle,
        item.department,
        item.phone,
        item.mobile,
        item.fax,
        item.email,
        item.company,
        item.address,
        item.website,
        item.note, 
        item.taxId
      ]);
      
      // Create data (Headers + Rows)
      const wsData = [headers, ...dataRows];
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Set column widths
      ws['!cols'] = [
        { wch: 15 },  // Name
        { wch: 20 },  // Job Title
        { wch: 20 },  // Department
        { wch: 20 },  // Phone
        { wch: 20 },  // Mobile
        { wch: 20 },  // Fax
        { wch: 30 },  // Email
        { wch: 25 },  // Company
        { wch: 40 },  // Address
        { wch: 30 },  // Website
        { wch: 30 },  // Note 
        { wch: 15 }   // Tax ID
      ];
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Card History');
      
      // Generate filename
      const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
      const filename = `BusinessCard_History_${timestamp}.xlsx`;
      
      // Export file
      XLSX.writeFile(wb, filename);
      
      showAlert('success', translations[currentLanguage].alertExcelDownloaded + filename);
    }
    
    function showAlert(type, message) {
      const alertSuccess = document.getElementById('alertSuccess');
      const alertError = document.getElementById('alertError');
      
      alertSuccess.classList.remove('show');
      alertError.classList.remove('show');
      
      // Use innerHTML because message now contains HTML icons
      if (type === 'success') {
        alertSuccess.innerHTML = message;
        alertSuccess.classList.add('show');
        setTimeout(() => alertSuccess.classList.remove('show'), 2000);
      } else {
        alertError.innerHTML = message;
        alertError.classList.add('show');
        setTimeout(() => alertError.classList.remove('show'), 5000);
      }
    }

    // Initialize button count on load
    window.onload = function() {
      updateExportButton();
    };
  </script>
</body>
</html>
