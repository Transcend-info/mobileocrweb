<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åç‰‡æƒæå°å·¥å…· (OCR)</title>
    
    <!-- Bootstrap CSS (UI ä»‹é¢) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Tesseract.js (OCR åœ–ç‰‡è½‰æ–‡å­—) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- SheetJS (åŒ¯å‡º Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f8f9fa; }
        .preview-container {
            max-height: 300px;
            overflow: hidden;
            border-radius: 10px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            margin-bottom: 20px;
        }
        #preview-image {
            max-width: 100%;
            max-height: 300px;
            display: none;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4 fw-bold text-primary">ğŸ“¸ åç‰‡æƒæå™¨</h2>

    <!-- åœ–ç‰‡ä¸Šå‚³å€ -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title">1. æ‹æ”æˆ–ä¸Šå‚³åç‰‡</h5>
            <div class="preview-container p-2">
                <span id="placeholder-text" class="text-muted">é è¦½å€åŸŸ</span>
                <img id="preview-image" alt="åç‰‡é è¦½">
            </div>
            
            <!-- capture="environment" è®“æ‰‹æ©Ÿç›´æ¥å‘¼å«å¾Œé¡é ­ -->
            <input type="file" class="form-control mb-3" id="file-input" accept="image/*" capture="environment">
            
            <button id="btn-scan" class="btn btn-primary w-100 btn-lg" disabled>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                é–‹å§‹è¾¨è­˜æ–‡å­— (OCR)
            </button>
            <div id="progress-text" class="text-center mt-2 text-muted small"></div>
        </div>
    </div>

    <!-- è¡¨å–®ç·¨è¼¯å€ -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title">2. ç¢ºèªèˆ‡ç·¨è¼¯è³‡æ–™</h5>
            <form id="contact-form">
                <div class="mb-3">
                    <label class="form-label">å§“å (Name)</label>
                    <input type="text" class="form-control" id="input-name" placeholder="è‡ªå‹•è¾¨è­˜...">
                </div>
                <div class="mb-3">
                    <label class="form-label">é›»è©± (Phone)</label>
                    <input type="tel" class="form-control" id="input-phone" placeholder="è‡ªå‹•è¾¨è­˜...">
                </div>
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="input-email" placeholder="è‡ªå‹•è¾¨è­˜...">
                </div>
                <div class="mb-3">
                    <label class="form-label">å…¬å¸ (Company)</label>
                    <input type="text" class="form-control" id="input-company" placeholder="è‡ªå‹•è¾¨è­˜...">
                </div>
                <div class="mb-3">
                    <label class="form-label">åŸå§‹è¾¨è­˜æ–‡å­— (Raw Text)</label>
                    <textarea class="form-control" id="raw-text" rows="3" placeholder="é€™è£¡æœƒé¡¯ç¤ºæ‰€æœ‰è¾¨è­˜å‡ºçš„æ–‡å­—ä¾›åƒè€ƒ"></textarea>
                </div>
            </form>
        </div>
    </div>

    <!-- åŒ¯å‡ºå€ -->
    <div class="d-grid gap-2">
        <button id="btn-export" class="btn btn-success btn-lg shadow">
            åŒ¯å‡º Excel (.xlsx)
        </button>
    </div>
</div>

<!-- è®€å–å‹•ç•«é®ç½© -->
<div class="loading-overlay" id="loading-overlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <p class="mt-3 fw-bold" id="loading-msg">æ­£åœ¨åˆå§‹åŒ–å¼•æ“...</p>
    <div class="progress w-75 mt-2" style="height: 5px;">
        <div id="loading-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
    </div>
</div>

<script>
    // DOM å…ƒç´ 
    const fileInput = document.getElementById('file-input');
    const previewImage = document.getElementById('preview-image');
    const placeholderText = document.getElementById('placeholder-text');
    const btnScan = document.getElementById('btn-scan');
    const btnExport = document.getElementById('btn-export');
    
    // è¼¸å…¥æ¬„ä½
    const inputName = document.getElementById('input-name');
    const inputPhone = document.getElementById('input-phone');
    const inputEmail = document.getElementById('input-email');
    const inputCompany = document.getElementById('input-company');
    const rawTextArea = document.getElementById('raw-text');

    // Loading å…ƒç´ 
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingMsg = document.getElementById('loading-msg');
    const loadingBar = document.getElementById('loading-bar');
    const progressText = document.getElementById('progress-text');

    // 1. åœ–ç‰‡é è¦½è™•ç†
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
                placeholderText.style.display = 'none';
                btnScan.disabled = false; // å•Ÿç”¨æƒææŒ‰éˆ•
                
                // æ¸…ç©ºèˆŠè³‡æ–™
                clearForm();
            }
            reader.readAsDataURL(file);
        }
    });

    // æ¸…ç©ºè¡¨å–®
    function clearForm() {
        inputName.value = '';
        inputPhone.value = '';
        inputEmail.value = '';
        inputCompany.value = '';
        rawTextArea.value = '';
        progressText.innerText = '';
    }

    // 2. Tesseract OCR è¾¨è­˜é‚è¼¯
    btnScan.addEventListener('click', async function() {
        const file = fileInput.files[0];
        if (!file) return;

        // é¡¯ç¤º Loading
        loadingOverlay.style.display = 'flex';
        btnScan.disabled = true;

        try {
            // å»ºç«‹ Worker
            const worker = await Tesseract.createWorker({
                logger: m => {
                    // æ›´æ–°é€²åº¦æ¢
                    if (m.status === 'recognizing text') {
                        loadingMsg.innerText = `æ­£åœ¨è¾¨è­˜æ–‡å­—... ${(m.progress * 100).toFixed(0)}%`;
                        loadingBar.style.width = `${m.progress * 100}%`;
                    } else {
                        loadingMsg.innerText = `ç‹€æ…‹: ${m.status}`;
                    }
                }
            });

            // è¼‰å…¥èªè¨€åŒ…ï¼šç¹é«”ä¸­æ–‡ + è‹±æ–‡
            await worker.loadLanguage('chi_tra+eng');
            await worker.initialize('chi_tra+eng');

            // åŸ·è¡Œè¾¨è­˜
            const { data: { text } } = await worker.recognize(file);
            
            // çµæŸ Worker
            await worker.terminate();

            // è™•ç†çµæœ
            loadingOverlay.style.display = 'none';
            btnScan.disabled = false;
            rawTextArea.value = text;
            
            // è‡ªå‹•å¡«å…¥æ¬„ä½ (è§£æé‚è¼¯)
            parseCardData(text);
            
            progressText.innerText = "è¾¨è­˜å®Œæˆï¼Œè«‹æ ¡å°è³‡æ–™ã€‚";
            progressText.className = "text-center mt-2 text-success fw-bold";

        } catch (error) {
            console.error(error);
            loadingOverlay.style.display = 'none';
            btnScan.disabled = false;
            alert('è¾¨è­˜ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚');
        }
    });

    // 3. ç°¡å–®çš„æ­£å‰‡è¡¨é”å¼è§£æ (Heuristics)
    function parseCardData(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        
        // --- Email è¾¨è­˜ ---
        // å°‹æ‰¾åŒ…å« @ çš„å­—ä¸²
        const emailRegex = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi;
        const emailMatch = text.match(emailRegex);
        if (emailMatch) {
            inputEmail.value = emailMatch[0];
        }

        // --- é›»è©±è¾¨è­˜ ---
        // æŠ“å–å¸¸è¦‹æ ¼å¼ï¼š09xx-xxx-xxx, (02)xxxx-xxxx, +886...
        // æ’é™¤æ‰å¤ªçŸ­çš„æ•¸å­—
        const phoneRegex = /((\+886|09|02|04|07|886)[\d\-\(\) ]{7,})/g;
        const phoneMatch = text.match(phoneRegex);
        if (phoneMatch) {
            // å–ç¬¬ä¸€å€‹çœ‹èµ·ä¾†æœ€åƒæ‰‹æ©Ÿæˆ–å¸‚è©±çš„
            inputPhone.value = phoneMatch[0];
        }

        // --- å…¬å¸èˆ‡å§“å (æœ€é›£çŒœï¼Œä½¿ç”¨é—œéµå­—æ’é™¤æ³•) ---
        let foundCompany = false;
        let foundName = false;

        // å¸¸è¦‹å…¬å¸å¾Œç¶´
        const companyKeywords = ['å…¬å¸', 'Company', 'Ltd', 'Inc', 'Corp', 'Group', 'Limited', 'ç§‘æŠ€', 'å¯¦æ¥­', 'å·¥ä½œå®¤'];
        // å¸¸è¦‹è·ç¨± (ç”¨ä¾†æ’é™¤ï¼Œå¦‚æœè©²è¡Œæœ‰è·ç¨±ï¼Œé€šå¸¸ä¸æ˜¯åå­—å°±æ˜¯å…¬å¸ï¼Œæˆ–æ˜¯åœ¨åå­—é™„è¿‘)
        const titleKeywords = ['ç¶“ç†', 'Manager', 'Director', 'å·¥ç¨‹å¸«', 'Engineer', 'å°ˆå“¡', 'CEO', 'CTO', 'ç‰¹åŠ©', 'ä»£è¡¨'];

        lines.forEach(line => {
            // å¦‚æœå·²ç¶“éƒ½æ‰¾åˆ°äº†å°±è·³é
            if (foundCompany && foundName) return;

            // åˆ¤æ–·æ˜¯å¦ç‚º Email æˆ– é›»è©± (è‹¥æ˜¯å‰‡è·³éè©²è¡Œ)
            if (line.includes('@') || (line.match(/\d/g) && line.match(/\d/g).length > 8)) return;

            // çŒœæ¸¬å…¬å¸
            if (!foundCompany && companyKeywords.some(keyword => line.includes(keyword))) {
                inputCompany.value = line;
                foundCompany = true;
                return;
            }

            // çŒœæ¸¬å§“å
            // é‚è¼¯ï¼šé•·åº¦è¼ƒçŸ­ (2~4å­—ä¸­æ–‡ æˆ– è‹±æ–‡å)ï¼Œä¸”ä¸åŒ…å«å…¬å¸é—œéµå­—ï¼Œä¸”é€šå¸¸åœ¨åç‰‡å­—é«”è¼ƒå¤§(ç„¡æ³•è¾¨è­˜å¤§å°ä½†é€šå¸¸åœ¨å‰å¹¾è¡Œ)
            if (!foundName && !foundCompany && line.length >= 2 && line.length < 20) {
                // æ’é™¤å«æœ‰æ•¸å­—çš„è¡Œ
                if (!/\d/.test(line)) {
                    inputName.value = line;
                    foundName = true;
                }
            }
        });
    }

    // 4. åŒ¯å‡º Excel (SheetJS)
    btnExport.addEventListener('click', function() {
        if (!inputName.value && !inputCompany.value) {
            if(!confirm("æ¬„ä½å¤§å¤šæ˜¯ç©ºçš„ï¼Œç¢ºå®šè¦åŒ¯å‡ºå—ï¼Ÿ")) return;
        }

        // æº–å‚™è³‡æ–™
        const data = [
            {
                "å§“å": inputName.value,
                "é›»è©±": inputPhone.value,
                "Email": inputEmail.value,
                "å…¬å¸": inputCompany.value,
                "å‚™è¨» (åŸå§‹æ–‡å­—)": rawTextArea.value
            }
        ];

        // å»ºç«‹å·¥ä½œè¡¨
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "åç‰‡è³‡æ–™");

        // ç”¢ç”Ÿæª”å (ä½¿ç”¨å§“åæˆ–æ™‚é–“)
        const filename = `åç‰‡_${inputName.value || 'æœªå‘½å'}_${new Date().toISOString().slice(0,10)}.xlsx`;

        // ä¸‹è¼‰æª”æ¡ˆ
        XLSX.writeFile(wb, filename);
    });

</script>
</body>
</html>